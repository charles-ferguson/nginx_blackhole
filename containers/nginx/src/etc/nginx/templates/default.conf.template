server {
  listen 80;
  server_name ${APP_NAME};

  location / {
    rewrite_by_lua_block {
      local uri_killswitch = io.open("${BLACKHOLE_PATH}/uri/" .. ngx.var.uri, "r")

      if uri_killswitch then
        ngx.exit(410)
      end

      local ip_killswitch = io.open("${BLACKHOLE_PATH}/uri/" .. ngx.var.remote_addr, "r")
      if ip_killswitch then
        ngx.exit(403)
      end
    }

    proxy_pass http://${APP_HOST}:${APP_PORT};
  }
}
